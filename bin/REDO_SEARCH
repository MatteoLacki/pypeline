"""
Script for redoing the search.
By default, it will replace the results of the previous analysis.

No need to run xml parser here: 'params.json' will just stay the same.

Matteo Lacki
"""

import argparse
from docstr2argparse import parse_arguments
import logging
from pathlib import Path
from pprint import pprint

from vodkas import iadbs, plgs
from vodkas.fastas import get_fastas
from vodkas.fs import copy_folder, find_free_path, rm_tree
from vodkas.header_txt import parse_header_txt
from vodkas.logging import get_logger

DEBUG = True

# if __name__ == '__main__':
get_args = lambda x: dict(parse_arguments(x))
A = {**get_args(iadbs), **get_args(get_fastas)}

default_out = 'C:/SYMPHONY_VODKAS/temp'
default_log = 'C:/SYMPHONY_VODKAS/temp_logs/plgs.log'
default_server = 'X:/SYMPHONY_VODKAS/temp_logs'
default_net_db = 'Y:/TESTRES' if DEBUG else 'Y:/RES'

parser = argparse.ArgumentParser(description='Rerun search with iaDBs: outcomes will be dumped in the same folders as the provided files are in.')
A['peptide3d_results'] = {
    'type': Path,
    'help': 'Path(s) to the peptide3d result files.',
    'nargs': "+"}
A["--log_file"] = {
    'type': Path,
    'default': default_log,
    'help': f"Local log file [default = {default_log}]."}
A["--log_server_folder"] = {
    'type': Path,
    'default': default_server,
    'help': f"Network folder for logs [default = {default_server}]."}
A["--network_db_folder"] = {
    'type': Path,
    'default': default_net_db,
    'help': f"Network folder for results. Set '' (empty word) if you want to skip copying [default = {default_net_db}]."}
del A['input_file'], A['output_dir'], A['fasta_file']

for name, kwds in sorted(A.items()):
    parser.add_argument(name, **kwds)

args = parser.parse_args().__dict__

log_file = args['log_file']
log_format = '%(asctime)s:%(name)s:%(levelname)s:%(message)s:'
logging.basicConfig(filename=log_file, format=log_format, level=logging.INFO)
logger = get_logger('RERUN_IADBS', log_format)
del args['log_file']

network_db_folder = args['network_db_folder']
if not network_db_folder.parents[0].exists():
    raise FileNotFoundError(f"Network drive missing: mount '{network_db_folder.parents[0]}'.")

print(f"Running analysis on folders:")
pprint(args['peptide3d_results'])

# pep3d = Y:\TESTRES\2019-112\O191101_02\O191101_02_Pep3D_Spectrum.xml
logger.info(f"Getting fastas: '{args['fastas']}'.")
fasta_file = get_fastas(**args)

for pep3d in args['peptide3d_results']:
    logger.info(f"Starting search on '{pep3d}'.")
    try:
        if not pep3d.exists():
            logger.info(f"File missing: {pep3d}")
            raise FileNotFoundError(f"Did not find {pep3d}")

        iadbs_out, _ = iadbs(pep3d, pep3d.parent, fasta_file, **args)
    except Exception as e:
        logger.warning(repr(e))

logger.info("Search redone.")